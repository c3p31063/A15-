```html
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ジョブ詳細 {{ job.id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --border:#eaeaea;
      --muted:#666;
      --bg:#f7f7f7;
      --badge-auto-pass:#e6ffed;
      --badge-manual-review:#fff8db;
      --badge-auto-block:#ffe6e6;
      --chip:#f0f3f7;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      margin: 24px;
      line-height: 1.6;
      color: #111;
    }
    a{color:#0659c6;text-decoration:none}
    a:hover{text-decoration:underline}
    header, section{max-width: 1080px; margin: 0 auto;}
    .backlink{margin-bottom:16px;display:inline-block}

    h1{margin: 8px 0 12px}
    h2{margin: 28px 0 12px; border-top: 1px solid var(--border); padding-top: 20px}
    h3{margin: 20px 0 8px}

    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px 12px;
      align-items:center;
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 8px;
    }
    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      border:1px solid var(--border);
    }
    .lv-auto_pass{background:var(--badge-auto-pass)}
    .lv-manual_review{background:var(--badge-manual-review)}
    .lv-auto_block{background:var(--badge-auto-block)}

    .kv{
      display:inline-grid;
      grid-template-columns:auto auto;
      gap: 4px 10px;
      font-size: 14px;
      color: #333;
      background: #fcfcfc;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    .kv dt{color:#555}
    .kv dd{margin:0}

    pre{
      white-space:pre-wrap;
      background:var(--bg);
      padding:12px;
      border-radius:8px;
      border:1px solid #eee;
      overflow:auto;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
      gap:12px;
    }
    .card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .card img{
      width:100%;
      height:auto;
      border-radius:8px;
      display:block;
    }
    .muted{color:var(--muted);font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Noto Sans Mono", monospace;}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:var(--chip);border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px}

    .urls-list{list-style: none; padding: 0; margin: 0}
    .urls-list li{padding:8px 0;border-bottom:1px dashed var(--border);word-break: break-all}
    .urls-actions{display:flex;gap:8px;margin:8px 0 0}
    .btn{
      appearance:none;border:1px solid var(--border);background:#fff;border-radius:8px;
      padding:6px 10px;cursor:pointer;font-size:12px
    }
    .btn:hover{background:#fafafa}
    .two-col{
      display:grid;grid-template-columns:2fr 1fr;gap:20px
    }
    @media (max-width: 960px){
      .two-col{grid-template-columns:1fr}
    }
    details summary{cursor:pointer; user-select:none}
    .divider{height:1px;background:var(--border);margin:16px 0}
  </style>
</head>
<body>

<header>
  <p class="backlink"><a href="/dashboard/">← ダッシュボードへ戻る</a></p>

  <h1>ジョブ #{{ job.id }}</h1>

  {% if job.result %}
    <div class="meta">
      <span>スコア: <strong>{{ job.result.risk_score_total }}</strong></span>
      <span class="badge lv-{{ job.result.risk_level }}">{{ job.result.risk_level }}</span>
      <span>閾値版: <span class="mono">{{ job.result.threshold_version }}</span></span>
    </div>
  {% endif %}

  <dl class="kv">
    <dt>種別</dt><dd>{{ job.kind }}</dd>
    <dt>状態</dt><dd>{{ job.status }}</dd>
    {% if job.created_at %}<dt>作成</dt><dd>{{ job.created_at }}</dd>{% endif %}
    {% if job.finished_at %}<dt>完了</dt><dd>{{ job.finished_at }}</dd>{% endif %}
    {% if job.prompt_text %}<dt>プロンプト</dt><dd class="mono">{{ job.prompt_text }}</dd>{% endif %}
  </dl>
</header>

<section>
  <h2>Evidence（詳細）</h2>

  {% for e in evidences %}
    <article class="card">
      <h3>#{{ forloop.counter }} {{ e.source }} <span class="muted">/ score={{ e.score_numeric }}</span></h3>

      {% if e.url %}
        <p>URL:
          <a href="{{ e.url }}" target="_blank" rel="noopener nofollow">{{ e.url }}</a>
        </p>
      {% endif %}

      {% if e.title %}<p class="muted">タイトル: {{ e.title }}</p>{% endif %}
      {% if e.note %}<p class="muted">備考: {{ e.note }}</p>{% endif %}

      {% if e.raw_json %}
        <details>
          <summary>raw_json を表示</summary>
          <pre>{{ e.raw_json|safe }}</pre>
        </details>
      {% endif %}
    </article>
  {% empty %}
    <p>Evidence はありません。</p>
  {% endfor %}
</section>

{% if job.kind == "image" %}
<section>
  <h2>ピックした類似画像</h2>

  {% if simimgs %}
    <div class="grid">
      {% for s in simimgs %}
        <div class="card">
          <a href="{{ s.match_url }}" target="_blank" rel="noopener nofollow">
            {% if s.thumbnail_url %}
              <img src="{{ s.thumbnail_url }}" alt="thumbnail" loading="lazy" referrerpolicy="no-referrer">
            {% else %}
              <div style="height:140px;display:flex;align-items:center;justify-content:center;background:#f5f5f5;border-radius:8px;">
                No thumbnail
              </div>
            {% endif %}
          </a>
          <div class="muted" style="margin-top:6px;">
            Rank: {{ s.rank }} / Score: {{ s.match_score }}
          </div>
          <div style="margin-top:6px;word-break:break-all;">
            <a href="{{ s.match_url }}" target="_blank" rel="noopener nofollow">{{ s.match_url }}</a>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>類似画像は登録されていません。</p>
  {% endif %}
</section>

<section>
  <h2>出典ページ（リンク一覧）</h2>
  {% comment %}
    SerpAPI / Vision WebDetection 由来のURLは Evidence にも格納される想定。
    ここでは URL を持つ Evidence を簡易リスト化して閲覧性を上げる。
  {% endcomment %}
  {% with url_count=0 %}
    <ul class="urls-list" id="pages-list">
      {% for e in evidences %}
        {% if e.url %}
          {% ifchanged e.url %}
            <li>
              <a href="{{ e.url }}" target="_blank" rel="noopener nofollow">{{ e.url }}</a>
            </li>
          {% endifchanged %}
        {% endif %}
      {% empty %}
        <li>出典ページは登録されていません。</li>
      {% endfor %}
    </ul>
    <div class="urls-actions">
      <button class="btn" type="button" onclick="copyUrls('pages-list')">URLをすべてコピー</button>
    </div>
  {% endwith %}
</section>
{% endif %}

{% if job.kind == "text" %}
<section>
  <h2>ピックした文献URL</h2>
  <ul class="urls-list" id="text-refs">
    {% for e in evidences %}
      {% if e.url %}
        <li><a href="{{ e.url }}" target="_blank" rel="noopener nofollow">{{ e.url }}</a></li>
      {% endif %}
    {% empty %}
      <li>文献は登録されていません。</li>
    {% endfor %}
  </ul>
  <div class="urls-actions">
    <button class="btn" type="button" onclick="copyUrls('text-refs')">URLをすべてコピー</button>
  </div>
</section>
{% endif %}

<section>
  <h2>デバッグ（開発向け）</h2>
  <div class="two-col">
    <div>
      <details>
        <summary>job（オブジェクト）</summary>
        <pre>{{ job|safe }}</pre>
      </details>
      {% if job.result %}
      <details>
        <summary>job.result（オブジェクト）</summary>
        <pre>{{ job.result|safe }}</pre>
      </details>
      {% endif %}
    </div>
    <div>
      <div class="chips">
        <span class="chip">ID: <span class="mono">{{ job.id }}</span></span>
        <span class="chip">Kind: <span class="mono">{{ job.kind }}</span></span>
        <span class="chip">Status: <span class="mono">{{ job.status }}</span></span>
        {% if job.result %}
          <span class="chip">Score: <span class="mono">{{ job.result.risk_score_total }}</span></span>
          <span class="chip">Level: <span class="mono">{{ job.result.risk_level }}</span></span>
          <span class="chip">Threshold: <span class="mono">{{ job.result.threshold_version }}</span></span>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
  // URL リストのテキストをまとめてクリップボードへコピー
  function copyUrls(listId){
    const list = document.getElementById(listId);
    if(!list){ return; }
    const links = Array.from(list.querySelectorAll('a'));
    const txt = links.map(a => a.href).join('\n');
    if(!txt){ alert('コピーするURLがありません'); return; }

    navigator.clipboard.writeText(txt)
      .then(() => alert('URLをコピーしました'))
      .catch(() => {
        // 失敗時はフォールバック
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try{
          document.execCommand('copy');
          alert('URLをコピーしました');
        }catch(e){
          alert('コピーに失敗しました');
        }
        document.body.removeChild(ta);
      });
  }
</script>

</body>
</html>
```
